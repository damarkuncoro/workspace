<%# View: Protected::Devices#show
    Tujuan: Refactor layout mengikuti pola Accounts#show (page_header, kt_grid, page_actions).
    Catatan: Gunakan atribut `label` sebagai nama tampil, bukan `name`.
    Prinsip: SRP, DRY, KISS, YAGNI. %>

<%= render 'protected/shared/partials/page_header',
  title: 'Detail Perangkat',
  subtitle: "#{@device.label} â€¢ #{@device.serial_number}" %>

<%# Baris 1: Informasi Perangkat %>
<%= kt_grid(cols: 1) do %>
  <%= kt_column(span: 1) do %>
    <div class="kt-card">
      <div class="kt-card-header">
        <h3 class="kt-card-title">Informasi Perangkat</h3>
      </div>
      <div class="kt-card-content">
        <%= kt_grid(cols: 1, cols_md: 2, gap: 4) do %>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Nama Perangkat</div>
            <div class="text-sm"><%= @device.label %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Tipe</div>
            <div class="text-sm"><%= @device.device_type.name %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Nomor Seri</div>
            <div class="text-sm font-mono"><%= @device.serial_number %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Status</div>
            <div>
              <% if @device.available? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Available</span>
              <% elsif @device.rented? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Rented</span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><%= @device.status.titleize %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Baris 1b: Sewa Saat Ini %>
  <%= kt_column(span: 1) do %>
    <div class="kt-card">
      <div class="kt-card-header">
        <h3 class="kt-card-title">Sewa Saat Ini</h3>
      </div>
      <div class="kt-card-content">
        <% if @device.current_customer %>
          <%= kt_grid(cols: 1, cols_md: 2, gap: 4) do %>
            <div class="space-y-1">
              <div class="text-sm font-medium text-muted-foreground">Pelanggan</div>
              <div class="text-sm"><%= @device.current_customer.person_name %></div>
            </div>
            <div class="space-y-1">
              <div class="text-sm font-medium text-muted-foreground">Email</div>
              <div class="text-sm"><%= @device.current_customer.account_email %></div>
            </div>
            <div class="space-y-1">
              <div class="text-sm font-medium text-muted-foreground">Disewa Sejak</div>
              <div class="text-sm"><%= @device.current_customer_device.rented_from.strftime('%b %d, %Y') %></div>
            </div>
            <div class="space-y-1">
              <div class="text-sm font-medium text-muted-foreground">Jatuh Tempo</div>
              <div class="text-sm">
                <% if @device.current_customer_device.rented_until %>
                  <%= @device.current_customer_device.rented_until.strftime('%b %d, %Y') %>
                <% else %>
                  <span class="text-muted-foreground">Ongoing</span>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-6 text-sm text-muted-foreground">Perangkat tersedia untuk disewa.</div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Baris 1c: Statistik Rental %>
  <%= kt_column(span: 1) do %>
    <div class="kt-card">
      <div class="kt-card-header">
        <h3 class="kt-card-title">Statistik Rental</h3>
      </div>
      <div class="kt-card-content">
        <%= kt_grid(cols: 1, cols_md: 2, gap: 4) do %>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Total Penyewaan</div>
            <div class="text-sm font-semibold"><%= @customer_devices.count %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Aktif</div>
            <div class="text-sm font-semibold"><%= @customer_devices.where(status: 'active').count %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Selesai</div>
            <div class="text-sm font-semibold"><%= @customer_devices.where(status: 'returned').count %></div>
          </div>
          <div class="space-y-1">
            <div class="text-sm font-medium text-muted-foreground">Dibuat</div>
            <div class="text-sm"><%= @device.created_at.strftime('%b %d, %Y') %></div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>

<%# Baris 2: Tindakan Cepat %>
<%= kt_grid(cols: 1) do %>
  <%= kt_column(span: 1) do %>
    <%= render 'protected/shared/partials/page_actions',
      card: true,
      title: 'Tindakan',
      justify: 'justify-start',
      gap_class: 'gap-3',
      links: [
        link_to('Edit Perangkat', edit_protected_device_path(@device), class: 'kt-btn kt-btn-warning'),
        link_to('Kembali ke Daftar', protected_devices_path, class: 'kt-btn kt-btn-outline'),
        link_to('Kembali ke Dashboard', protected_dashboard_path, class: 'kt-btn kt-btn-outline')
      ] %>
  <% end %>
<% end %>

<%# Baris 3: Riwayat Penyewaan %>
<%= kt_grid(cols: 1) do %>
  <%= kt_column(span: 1) do %>
    <div class="kt-card">
      <div class="kt-card-header">
        <h3 class="kt-card-title">Riwayat Penyewaan</h3>
      </div>
      <div class="kt-card-content">
        <% if @customer_devices.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-border">
              <thead>
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Pelanggan</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Periode</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Aksi</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @customer_devices.each do |customer_device| %>
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm"><%= customer_device.customer.person_name %></div>
                      <div class="text-xs text-muted-foreground"><%= customer_device.customer.account_email %></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm"><%= customer_device.rented_from.strftime('%b %d, %Y') %></div>
                      <div class="text-xs text-muted-foreground">
                        <% if customer_device.rented_until %>
                          s/d <%= customer_device.rented_until.strftime('%b %d, %Y') %>
                        <% else %>
                          Berjalan
                        <% end %>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <% if customer_device.active? %>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Aktif</span>
                      <% else %>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><%= customer_device.status.titleize %></span>
                      <% end %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <%= link_to protected_customer_device_path(customer_device.customer, customer_device), class: 'text-primary hover:underline' do %>
                        Lihat Detail
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-6 text-sm text-muted-foreground">Belum ada riwayat penyewaan.</div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>

<%# Baris 4: Aktivitas Perangkat %>
<%= kt_grid(cols: 1) do %>
  <%= kt_column(span: 1) do %>
    <div class="kt-card">
      <div class="kt-card-header">
        <h3 class="kt-card-title">Aktivitas Perangkat</h3>
      </div>
      <div class="kt-card-content">
        <% if @device_activities.any? %>
          <div class="space-y-3">
            <% @device_activities.each do |activity| %>
              <div class="flex items-center justify-between p-3 bg-muted rounded-lg">
                <div>
                  <p class="text-sm font-medium"><%= activity.description %></p>
                  <p class="text-xs text-muted-foreground"><%= activity.recorded_at.strftime('%B %d, %Y %H:%M') %></p>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><%= activity.event_type.titleize %></span>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-6 text-sm text-muted-foreground">Belum ada aktivitas.</div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
